name: C/C++ CI

on:
  push:
    branches: [feature/unified_workflow]
  pull_request:
    branches: [master, develop, testing]

jobs:

  linux_64_bit:
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Ubuntu20.04_x64 gcc10
            os : ubuntu-20.04
            cc : gcc-10
            cxx : g++-10
            packages: gcc-10 g++-10

          - name: Ubuntu20.04_x64 clang12
            os : ubuntu-20.04
            cc : clang-12
            cxx : clang++-12
            packages: gcc-10 g++-10 clang-12

          - name: Ubuntu22.04_x64 gcc12
            os: ubuntu-22.04
            cc: gcc-12
            cxx: g++-12
            packages: gcc-12 g++-12

          - name: Ubuntu22.04_x64 clang14
            os: ubuntu-22.04
            cc: clang-14
            cxx: clang++-14
            packages: gcc-12 g++-12 clang-14

    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    env:
      CC: ${{ matrix.config.cc }}
      CXX: ${{ matrix.config.cxx }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt-get install ${{ matrix.config.packages }} libusb-1.0.0-dev libgtk-3-dev rpm

      - name: make debug
        run: sudo make clean && make debug

      - name: make test
        run: sudo make clean && make test

      - name: make release
        run: sudo make clean && make release

      - name: sudo make install
        run: sudo make clean && sudo make install

      - name: sudo make package
        run: sudo make package

      - name: sudo make uninstall
        run: sudo make uninstall && sudo make clean

  linux_32_bit:
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Ubuntu20.04_x32 gcc10
            os : ubuntu-20.04
            cc : gcc-10
            cxx : g++-10
            packages: gcc-10-multilib g++-10-multilib

          - name: Ubuntu20.04_x32 clang12
            os : ubuntu-20.04
            cc : clang-12
            cxx : clang++-12
            packages: gcc-10-multilib g++-10-multilib clang-12

          - name: Ubuntu22.04_x32 gcc12
            os: ubuntu-22.04
            cc: gcc-12
            cxx: g++-12
            packages: gcc-12-multilib g++-12-multilib

          - name: Ubuntu22.04_x32 clang14
            os: ubuntu-22.04
            cc: clang-14
            cxx: clang++-14
            packages: gcc-12-multilib g++-12-multilib clang-14

    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    env:
      CC: ${{ matrix.config.cc }}
      CXX: ${{ matrix.config.cxx }}
      CFLAGS: -m32
      CXXFLAGS: -m32
      LDFLAGS: -m32

    steps:
      - uses: actions/checkout@v4

      - name: Allow for i386 packages to be installed (used for libusb)
        run: sudo dpkg --add-architecture i386

      - name: Install dependencies
        run: sudo apt update && sudo apt-get install libc6-dev:i386 ${{ matrix.config.packages }} libusb-1.0.0-dev:i386 rpm

      - name: make debug
        run: sudo make clean && make debug

      - name: make test
        run: sudo make clean && make test

      - name: make release
        run: sudo make clean && make release

      - name: sudo make install
        run: sudo make clean && sudo make install

      - name: sudo make package
        run: sudo make package

      - name: sudo make uninstall
        run: sudo make uninstall && sudo make clean

  job_windows_msvc:
    name: windows MSVC
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: debug
        run: |
          mkdir build
          mkdir build\\debug
          cd build\\debug
          cmake ..\\.. -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE="Debug"
          cmake --build . --target ALL_BUILD
      - name: make release
        run: |
          mkdir build\\release
          cd build\\release
          cmake ..\\.. -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE="Release"
          cmake --build . --target ALL_BUILD
      - name: make install
        run: |
          cd build\\release
          cmake --build . --target INSTALL
      - name: sudo make uninstall
        run: |
          cd build\\release
          cmake --build . --target uninstall
# Linux MinGW cross compliation

# job_linux_22_04_cross:
#   name: ubuntu-22.04 mingw64
#   runs-on: ubuntu-22.04
#   steps:
#     - uses: actions/checkout@v4
#     - name: Install dependencies
#       run: sudo apt-get install gcc-12 libusb-1.0.0-dev libgtk-3-dev rpm mingw-w64
#     - name: Building Release for Windows (x86-64) ...
#       run: sudo mkdir -p build-mingw && cd build-mingw && sudo cmake \
#         -DCMAKE_SYSTEM_NAME=Windows \
#         -DTOOLCHAIN_PREFIX=x86_64-w64-mingw32 \
#         -DCMAKE_TOOLCHAIN_FILE=$PWD/../cmake/modules/set_toolchain.cmake \
#         -DCMAKE_INSTALL_PREFIX=$PWD/install $PWD && \
#         sudo make && sudo rm -rf build-mingw && cd -
